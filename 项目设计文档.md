# 私密相册管理系统 - 项目设计文档

## 一、项目概述

### 1.1 项目简介
一个基于密码访问的私密相册网站，包含用户前台展示和管理后台两大模块。

### 1.2 技术栈
- **前端**: Vue 3 + Vue Router + Pinia + Element Plus
- **后端**: Node.js + Express + Sequelize ORM
- **数据库**: PostgreSQL
- **文件存储**: 本地文件系统
- **认证**: JWT Token

### 1.3 项目特点
- 全栈一体化架构，前后端不分离
- 支持多级分类管理
- 批量图片上传（支持几十张）
- 灵活的排序功能
- 密码保护访问

---

## 二、系统架构

### 2.1 目录结构
```
photo-album/
├── server/                 # 后端代码
│   ├── config/            # 配置文件
│   │   └── database.js    # 数据库配置
│   ├── models/            # 数据模型
│   │   ├── SiteConfig.js
│   │   ├── Category.js
│   │   ├── Album.js
│   │   └── Photo.js
│   ├── routes/            # 路由
│   │   ├── auth.js
│   │   ├── frontend.js
│   │   └── admin.js
│   ├── middleware/        # 中间件
│   │   └── auth.js
│   ├── uploads/           # 上传文件存储
│   └── app.js             # 入口文件
├── src/                   # 前端代码
│   ├── views/             # 页面组件
│   │   ├── frontend/      # 前台页面
│   │   │   ├── Login.vue
│   │   │   ├── Home.vue
│   │   │   ├── AlbumList.vue
│   │   │   └── PhotoGallery.vue
│   │   └── admin/         # 后台页面
│   │       ├── AdminLogin.vue
│   │       ├── Dashboard.vue
│   │       ├── SiteSettings.vue
│   │       ├── PasswordManage.vue
│   │       ├── CategoryManage.vue
│   │       ├── AlbumManage.vue
│   │       └── PhotoManage.vue
│   ├── router/            # 路由配置
│   ├── stores/            # 状态管理
│   ├── api/               # API 接口
│   └── App.vue
├── package.json
└── vite.config.js
```

---

## 三、数据库设计

### 3.1 表结构

#### 3.1.1 站点配置表 (site_configs)
```sql
CREATE TABLE site_configs (
    id SERIAL PRIMARY KEY,
    site_title VARCHAR(255) NOT NULL DEFAULT '私密相册',
    site_description TEXT,
    access_password VARCHAR(255) NOT NULL,  -- bcrypt 哈希
    admin_password VARCHAR(255) NOT NULL,   -- bcrypt 哈希
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.2 分类表 (categories)
```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    cover_image VARCHAR(500),
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_categories_sort ON categories(sort_order);
```

#### 3.1.3 相册表 (albums)
```sql
CREATE TABLE albums (
    id SERIAL PRIMARY KEY,
    category_id INTEGER NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    cover_image VARCHAR(500),
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_albums_category ON albums(category_id);
CREATE INDEX idx_albums_sort ON albums(sort_order);
```

#### 3.1.4 照片表 (photos)
```sql
CREATE TABLE photos (
    id SERIAL PRIMARY KEY,
    album_id INTEGER NOT NULL REFERENCES albums(id) ON DELETE CASCADE,
    file_name VARCHAR(500) NOT NULL,      -- 存储路径
    original_name VARCHAR(255) NOT NULL,  -- 原始文件名
    file_size INTEGER,                    -- 文件大小(字节)
    sort_order INTEGER DEFAULT 0,
    upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_photos_album ON photos(album_id);
CREATE INDEX idx_photos_sort ON photos(sort_order);
```

### 3.2 初始化数据
```sql
-- 插入默认配置
INSERT INTO site_configs (site_title, site_description, access_password, admin_password) 
VALUES (
    '我的私密相册', 
    '欢迎来到我的私密相册',
    '$2b$10$...', -- 默认密码: user123 (需要 bcrypt 加密)
    '$2b$10$...'  -- 默认密码: admin123 (需要 bcrypt 加密)
);
```

---

## 四、API 接口设计

### 4.1 前台接口

#### 4.1.1 用户登录
```
POST /api/login
Body: { password: string }
Response: { token: string, message: string }
```

#### 4.1.2 获取所有分类
```
GET /api/categories
Headers: { Authorization: Bearer <token> }
Response: { data: Category[] }
```

#### 4.1.3 获取分类下的相册列表
```
GET /api/albums?category_id=<id>
Headers: { Authorization: Bearer <token> }
Response: { data: Album[] }
```

#### 4.1.4 获取相册内的照片
```
GET /api/photos?album_id=<id>
Headers: { Authorization: Bearer <token> }
Response: { data: Photo[] }
```

### 4.2 后台管理接口

#### 4.2.1 管理员登录
```
POST /api/admin/login
Body: { password: string }
Response: { token: string, message: string }
```

#### 4.2.2 站点设置
```
GET /api/admin/settings
PUT /api/admin/settings
Body: { site_title: string, site_description: string }
```

#### 4.2.3 密码管理
```
POST /api/admin/change-password
Body: { 
    type: 'access' | 'admin',
    old_password: string,
    new_password: string 
}
```

#### 4.2.4 分类管理
```
GET    /api/admin/categories          # 获取所有分类
POST   /api/admin/categories          # 创建分类
PUT    /api/admin/categories/:id      # 更新分类
DELETE /api/admin/categories/:id      # 删除分类
POST   /api/admin/categories/sort     # 排序
Body: { orders: [{ id: number, sort_order: number }] }
```

#### 4.2.5 相册管理
```
GET    /api/admin/albums              # 获取所有相册
POST   /api/admin/albums              # 创建相册
PUT    /api/admin/albums/:id          # 更新相册
DELETE /api/admin/albums/:id          # 删除相册
POST   /api/admin/albums/sort         # 排序
Body: { orders: [{ id: number, sort_order: number }] }
```

#### 4.2.6 照片管理
```
GET    /api/admin/photos?album_id=<id>  # 获取相册照片
POST   /api/admin/upload                # 批量上传
DELETE /api/admin/photos                # 批量删除
Body: { ids: number[] }
POST   /api/admin/photos/sort           # 排序
Body: { orders: [{ id: number, sort_order: number }] }
```

---

## 五、功能模块详细设计

### 5.1 前台用户端

#### 5.1.1 登录页 (Login.vue)
**功能**:
- 输入密码验证
- 验证通过后获取 Token 并跳转到主页
- Token 存储在 localStorage

**交互流程**:
1. 用户输入密码
2. 调用 POST /api/login
3. 成功后保存 Token，跳转到 /home
4. 失败则提示错误信息

#### 5.1.2 分类展示页 (Home.vue)
**功能**:
- 展示所有顶级分类（卡片式布局）
- 显示分类封面、名称、描述
- 点击分类进入相册列表页

**数据加载**:
- 调用 GET /api/categories
- 按 sort_order 排序显示

#### 5.1.3 相册列表页 (AlbumList.vue)
**功能**:
- 展示某个分类下的所有相册
- 显示相册封面、名称、描述
- 点击相册进入照片详情页

**数据加载**:
- 调用 GET /api/albums?category_id=xxx
- 按 sort_order 排序显示

#### 5.1.4 照片详情页 (PhotoGallery.vue)
**功能**:
- 展示相册内所有照片
- 支持瀑布流或网格布局
- 点击图片可放大查看（灯箱效果）
- 支持左右切换浏览

**技术实现**:
- 使用 vue3-photo-preview 或 vue-easy-lightbox
- 图片懒加载优化性能

### 5.2 管理后台

#### 5.2.1 后台登录 (AdminLogin.vue)
**功能**:
- 管理员密码验证
- 获取管理员 Token

#### 5.2.2 仪表盘 (Dashboard.vue)
**功能**:
- 显示统计信息：分类数、相册数、照片总数
- 快捷导航到各管理模块

#### 5.2.3 站点设置 (SiteSettings.vue)
**功能**:
- 修改站点标题
- 修改站点描述
- 实时保存

#### 5.2.4 密码管理 (PasswordManage.vue)
**功能**:
- 修改前台访问密码
- 修改后台管理密码
- 需要输入旧密码验证

**安全措施**:
- 密码使用 bcrypt 加盐哈希
- 传输时使用 HTTPS
- 密码强度验证

#### 5.2.5 分类管理 (CategoryManage.vue)
**功能**:
- 列表展示所有分类
- 添加新分类（名称、描述、封面图）
- 编辑分类信息
- 删除分类（需检查是否有关联相册）
- 拖拽排序功能

**技术实现**:
- 使用 Sortable.js 实现拖拽
- 删除前弹窗确认

#### 5.2.6 相册管理 (AlbumManage.vue)
**功能**:
- 列表展示所有相册
- 添加新相册（名称、选择分类、封面图、描述）
- 编辑相册信息
- 删除相册
- 拖拽排序功能
- "进入排序模式"按钮切换排序状态

**技术实现**:
- 使用 Sortable.js
- 排序模式下禁用其他操作

#### 5.2.7 照片管理 (PhotoManage.vue)
**功能**:
- 下拉选择要管理的相册
- 批量上传照片（支持几十张）
- 显示上传进度
- 照片列表展示（缩略图）
- 批量选择删除
- 拖拽排序

**技术实现**:
- 使用 `<input type="file" multiple>` 或 Element Plus Upload 组件
- 分片上传大文件
- 显示每个文件的上传进度
- 使用 Sortable.js 排序

---

## 六、技术实现要点

### 6.1 批量上传实现

#### 前端
```javascript
// 使用 FormData 上传多文件
const uploadFiles = async (files, albumId) => {
  const formData = new FormData();
  formData.append('album_id', albumId);
  
  files.forEach(file => {
    formData.append('photos', file);
  });
  
  const response = await axios.post('/api/admin/upload', formData, {
    headers: { 'Content-Type': 'multipart/form-data' },
    onUploadProgress: (progressEvent) => {
      const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
      // 更新进度条
    }
  });
};
```

#### 后端
```javascript
// 使用 multer 处理多文件上传
const multer = require('multer');
const storage = multer.diskStorage({
  destination: './server/uploads/',
  filename: (req, file, cb) => {
    const uniqueName = Date.now() + '-' + Math.round(Math.random() * 1E9) + 
                       path.extname(file.originalname);
    cb(null, uniqueName);
  }
});

const upload = multer({ 
  storage,
  limits: { fileSize: 10 * 1024 * 1024 } // 10MB 限制
});

router.post('/upload', upload.array('photos', 50), async (req, res) => {
  // 批量插入数据库
});
```

### 6.2 拖拽排序实现

```javascript
// 使用 Sortable.js
import Sortable from 'sortablejs';

onMounted(() => {
  const el = document.getElementById('sortable-list');
  Sortable.create(el, {
    animation: 150,
    onEnd: async (evt) => {
      // 更新排序
      const orders = items.value.map((item, index) => ({
        id: item.id,
        sort_order: index
      }));
      
      await axios.post('/api/admin/albums/sort', { orders });
    }
  });
});
```

### 6.3 认证中间件

```javascript
// server/middleware/auth.js
const jwt = require('jsonwebtoken');

const authMiddleware = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ message: '未授权访问' });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    res.status(401).json({ message: 'Token 无效' });
  }
};
```

### 6.4 密码加密

```javascript
const bcrypt = require('bcrypt');

// 加密
const hashedPassword = await bcrypt.hash(password, 10);

// 验证
const isValid = await bcrypt.compare(inputPassword, hashedPassword);
```

---

## 七、部署说明

### 7.1 环境变量配置
```env
# .env
NODE_ENV=production
PORT=3000

# 数据库
DB_HOST=localhost
DB_PORT=5432
DB_NAME=photo_album
DB_USER=postgres
DB_PASSWORD=your_password

# JWT
JWT_SECRET=your_secret_key_here
JWT_EXPIRE=7d

# 文件上传
UPLOAD_PATH=./server/uploads
MAX_FILE_SIZE=10485760
```

### 7.2 构建命令
```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 生产构建
npm run build

# 启动服务
npm start
```

### 7.3 数据库初始化
```bash
# 创建数据库
createdb photo_album

# 运行迁移脚本
node server/scripts/init-db.js
```

---

## 八、安全考虑

1. **密码安全**: 使用 bcrypt 加盐哈希，永不明文存储
2. **SQL 注入防护**: 使用 Sequelize ORM 参数化查询
3. **XSS 防护**: 前端输入验证和转义
4. **CSRF 防护**: 使用 Token 验证
5. **文件上传安全**: 
   - 限制文件类型（仅允许图片）
   - 限制文件大小
   - 重命名上传文件
6. **访问控制**: JWT Token 验证，区分前台和后台权限

---

## 九、性能优化

1. **图片优化**:
   - 上传时自动生成缩略图
   - 使用 WebP 格式
   - 图片懒加载

2. **数据库优化**:
   - 添加必要索引
   - 分页查询大量数据

3. **缓存策略**:
   - 静态资源 CDN 缓存
   - API 响应缓存（Redis）

4. **前端优化**:
   - 路由懒加载
   - 组件按需加载
   - 图片虚拟滚动

---

## 十、后续扩展功能

1. 图片标签系统
2. 搜索功能
3. 评论功能
4. 分享链接生成
5. 图片编辑功能
6. 多用户支持
7. 移动端适配
8. 图片 EXIF 信息展示

---

## 附录：技术栈版本建议

- Node.js: >= 18.x
- Vue: 3.3.x
- PostgreSQL: >= 14.x
- Express: 4.18.x
- Sequelize: 6.x
- Element Plus: 2.4.x
- Sortable.js: 1.15.x
